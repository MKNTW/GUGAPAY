<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GugaCoin</title>
  <link rel="icon" href="1.png" type="image/png">
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
  <!-- –û—Å–Ω–æ–≤–Ω–æ–π UI (—Å–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
  <div id="balanceDisplay" class="hidden">
    <span id="balanceLabel">‚Ç≤</span>
    <span id="balanceValue">0.00000</span>
  </div>
  <div id="mineContainer" class="hidden">
    <img id="mineBtn" src="1.png" alt="–ú–∞–π–Ω–∏—Ç—å">
  </div>

  <!-- –°–∫—Ä–∏–ø—Ç —Å–æ –≤—Å–µ–º –∫–æ–¥–æ–º –∫–ª–∏–µ–Ω—Ç–∞ -->
  <script>
// ==================== –ù–ê–°–¢–†–û–ô–ö–ò ======================
const API_URL = "https://mkntw-github-io.onrender.com"; // –£–∫–∞–∂–∏—Ç–µ –≤–∞—à URL —Å–µ—Ä–≤–µ—Ä–∞
let currentUserId = null;
let pendingMinedCoins = parseFloat(localStorage.getItem("pendingMinedCoins")) || 0;
let mineTimer = null;
let localBalance = 0;
let updateInterval = null;
let isMining = false;

// ==================== –§–£–ù–ö–¶–ò–ò UI ======================
function logout() {
  localStorage.removeItem("userId");
  currentUserId = null;
  
  const topBar = document.getElementById("topBar");
  if (topBar) {
    topBar.remove();
  }
  const bottomBar = document.getElementById("bottomBar");
  if (bottomBar) {
    bottomBar.remove();
  }
  
  const balanceDisplay = document.getElementById("balanceDisplay");
  if (balanceDisplay) balanceDisplay.classList.add("hidden");
  const mineContainer = document.getElementById("mineContainer");
  if (mineContainer) mineContainer.classList.add("hidden");

  closeAllModals();
  
  clearInterval(updateInterval);
  
  const userIdDisplay = document.getElementById("userIdDisplay");
  if (userIdDisplay) userIdDisplay.textContent = "";

  openAuthModal();
}

function updateTopBar() {
  const userIdDisplay = document.getElementById("userIdDisplay");
  userIdDisplay.textContent = currentUserId ? `ID: ${currentUserId}` : "";
}

function showMainUI() {
  if (!document.getElementById("topBar")) {
    const topBar = document.createElement("div");
    topBar.id = "topBar";
    topBar.innerHTML = `
      <div id="topBarLeft">
        <div id="appTitle">GugaCoin</div>
        <div id="userIdDisplay"></div>
      </div>
      <div id="topBarRight">
        <button id="logoutBtn">–í—ã—Ö–æ–¥</button>
      </div>
    `;
    document.body.appendChild(topBar);
    document.getElementById("logoutBtn").addEventListener("click", logout);
  }
  document.getElementById("topBar").classList.remove("hidden");

  if (!document.getElementById("bottomBar")) {
    const bottomBar = document.createElement("div");
    bottomBar.id = "bottomBar";
    bottomBar.innerHTML = `
      <button id="paymentBtn">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      <button id="historyBtn">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button id="exchangeBtn">–û–±–º–µ–Ω—è—Ç—å</button>
      <!-- –ù–û–í–û–ï: –∫–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç–∏—Ç—å –º–µ—Ä—á–∞–Ω—Ç—É -->
      <button id="merchantPayBtn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
    `;
    document.body.appendChild(bottomBar);
    document.getElementById("paymentBtn").addEventListener("click", openPaymentModal);
    document.getElementById("historyBtn").addEventListener("click", openHistoryModal);
    document.getElementById("exchangeBtn").addEventListener("click", openExchangeModal);

    // –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã –º–µ—Ä—á–∞–Ω—Ç—É
    document.getElementById("merchantPayBtn").addEventListener("click", openMerchantPayModal);
  }
  document.getElementById("bottomBar").classList.remove("hidden");

  document.getElementById("balanceDisplay").classList.remove("hidden");
  document.getElementById("mineContainer").classList.remove("hidden");

  // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ‚Äì –∫–∞–∂–¥—ã–µ 2000 –º—Å (2 —Å–µ–∫—É–Ω–¥—ã)
  updateInterval = setInterval(fetchUserData, 2000);
}

function hideMainUI() {
  if (document.getElementById("topBar")) {
    document.getElementById("topBar").classList.add("hidden");
  }
  if (document.getElementById("bottomBar")) {
    document.getElementById("bottomBar").classList.add("hidden");
  }
  document.getElementById("balanceDisplay").classList.add("hidden");
  document.getElementById("mineContainer").classList.add("hidden");
  clearInterval(updateInterval);
}

function closeAllModals() {
  const modals = document.querySelectorAll(".modal");
  modals.forEach((modal) => modal.classList.add("hidden"));
}

function createModal(id, content) {
  let modal = document.getElementById(id);
  if (modal) return modal;
  modal = document.createElement("div");
  modal.id = id;
  modal.className = "modal hidden";
  
  modal.innerHTML = `
    <div class="modal-overlay"></div>
    <div class="modal-content">${content}</div>
  `;
  
  document.body.appendChild(modal);

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
  const modalsWithOverlayClickClose = ["paymentModal", "historyModal", "exchangeModal", "merchantPayModal", "confirmMerchantPaymentModal"];
  if (modalsWithOverlayClickClose.includes(id)) {
    const overlay = modal.querySelector(".modal-overlay");
    if (overlay) {
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) {
          modal.remove();
          fetchUserData();
        }
      });
      overlay.addEventListener("touchend", (e) => {
        setTimeout(() => {
          if (e.target === overlay) {
            modal.remove();
            fetchUserData();
          }
        }, 100);
      });
    }
  }
  
  return modal;
}

function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove("hidden");
    fetchUserData();
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) modal.classList.add("hidden");
  fetchUserData();
}

/* ------------------------------
   –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
------------------------------ */
function removeAuthModal() {
  const authModal = document.getElementById("authModal");
  if (authModal) authModal.remove();
}

function openLoginSection() {
  const loginSection = document.getElementById("loginSection");
  const registerSection = document.getElementById("registerSection");
  if (loginSection) loginSection.style.display = "block";
  if (registerSection) registerSection.style.display = "none";
}

function openRegisterSection() {
  const loginSection = document.getElementById("loginSection");
  const registerSection = document.getElementById("registerSection");
  if (loginSection) loginSection.style.display = "none";
  if (registerSection) registerSection.style.display = "block";
}

function openAuthModal() {
  hideMainUI();
  let authModal = document.getElementById("authModal");
  if (!authModal) {
    authModal = document.createElement("div");
    authModal.id = "authModal";
    authModal.className = "modal hidden";
    authModal.innerHTML = `
      <div class="modal-content">
        <h3>GugaCoin</h3>
        <div id="authForm">
          <div id="loginSection">
            <h4 style="text-align: left;">–í—Ö–æ–¥</h4>
            <input type="text" id="loginInput" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="loginSubmitBtn">–í–æ–π—Ç–∏</button>
          </div>
          <div id="registerSection" style="display: none;">
            <h4 style="text-align: left;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
            <input type="text" id="regLogin" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="registerSubmitBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>
        </div>
        <button id="toggleAuthBtn" style="margin-top:20px;">–í–æ–π—Ç–∏/–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
    `;
    document.body.appendChild(authModal);
    const loginSubmitBtn = authModal.querySelector("#loginSubmitBtn");
    const registerSubmitBtn = authModal.querySelector("#registerSubmitBtn");
    const toggleAuthBtn = authModal.querySelector("#toggleAuthBtn");
    if (loginSubmitBtn) loginSubmitBtn.addEventListener("click", login);
    if (registerSubmitBtn) registerSubmitBtn.addEventListener("click", register);
    if (toggleAuthBtn) {
      toggleAuthBtn.addEventListener("click", () => {
        const loginSection = authModal.querySelector("#loginSection");
        const registerSection = authModal.querySelector("#registerSection");
        if (loginSection.style.display === "block") {
          loginSection.style.display = "none";
          registerSection.style.display = "block";
        } else {
          loginSection.style.display = "block";
          registerSection.style.display = "none";
        }
      });
    }
  }
  openLoginSection();
  openModal("authModal");
}

function formatBalance(balance) {
  return parseFloat(balance).toFixed(5);
}

// ==================== –ú–ê–ô–ù–ò–ù–ì ======================
function mineCoins() {
  if (!currentUserId) return;
  clearInterval(updateInterval);
  isMining = true;
  pendingMinedCoins = parseFloat((pendingMinedCoins + 0.00001).toFixed(5));
  localStorage.setItem("pendingMinedCoins", pendingMinedCoins);
  localBalance = parseFloat((localBalance + 0.00001).toFixed(5));
  updateBalanceUI();
  
  if (mineTimer) clearTimeout(mineTimer);

  mineTimer = setTimeout(() => {
    isMining = false;
    flushMinedCoins();
    updateInterval = setInterval(fetchUserData, 2000);
  }, 1500);
}

function updateBalanceUI() {
  const balanceValue = document.getElementById("balanceValue");
  if (balanceValue) {
    balanceValue.textContent = formatBalance(localBalance);
  }
}

async function flushMinedCoins() {
  if (!currentUserId || pendingMinedCoins <= 0) return;
  try {
    const response = await fetch(`${API_URL}/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: currentUserId, amount: pendingMinedCoins })
    });
    if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
    pendingMinedCoins = 0;
    localStorage.removeItem("pendingMinedCoins");
    fetchUserData();
  } catch (error) {
    console.error("[FlushMinedCoins] –û—à–∏–±–∫–∞:", error);
  }
}

function flushMinedCoinsSync() {
  if (!currentUserId || pendingMinedCoins <= 0) return;
  const xhr = new XMLHttpRequest();
  xhr.open("POST", `${API_URL}/update`, false);
  xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
  try {
    xhr.send(JSON.stringify({ userId: currentUserId, amount: pendingMinedCoins }));
    pendingMinedCoins = 0;
    localStorage.removeItem("pendingMinedCoins");
  } catch (error) {
    console.error("[FlushMinedCoinsSync] –û—à–∏–±–∫–∞:", error);
  }
}

// ==================== –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ======================
function createUI() {
  if (!document.getElementById("topBar")) {
    const topBar = document.createElement("div");
    topBar.id = "topBar";
    topBar.innerHTML = `
      <div id="topBarLeft">
        <div id="appTitle">GugaCoin</div>
        <div id="userIdDisplay"></div>
      </div>
      <div id="topBarRight">
        <button id="logoutBtn">–í—ã—Ö–æ–¥</button>
      </div>
    `;
    document.body.appendChild(topBar);
    document.getElementById("logoutBtn").addEventListener("click", logout);
  }
  document.getElementById("topBar").classList.remove("hidden");

  if (!document.getElementById("bottomBar")) {
    const bottomBar = document.createElement("div");
    bottomBar.id = "bottomBar";
    bottomBar.innerHTML = `
      <button id="paymentBtn">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      <button id="historyBtn">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button id="exchangeBtn">–û–±–º–µ–Ω—è—Ç—å</button>
      <!-- –ù–û–í–û–ï: –∫–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç–∏—Ç—å –º–µ—Ä—á–∞–Ω—Ç—É -->
      <button id="merchantPayBtn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
    `;
    document.body.appendChild(bottomBar);
    document.getElementById("paymentBtn").addEventListener("click", openPaymentModal);
    document.getElementById("historyBtn").addEventListener("click", openHistoryModal);
    document.getElementById("exchangeBtn").addEventListener("click", openExchangeModal);

    // –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã –º–µ—Ä—á–∞–Ω—Ç—É
    document.getElementById("merchantPayBtn").addEventListener("click", openMerchantPayModal);
  }
  document.getElementById("topBar").classList.remove("hidden");
  document.getElementById("bottomBar").classList.remove("hidden");
  document.getElementById("balanceDisplay").classList.remove("hidden");
  document.getElementById("mineContainer").classList.remove("hidden");

  updateInterval = setInterval(fetchUserData, 2000);
}

function updateUI() {
  if (currentUserId) {
    updateTopBar();
    showMainUI();
    removeAuthModal();
  } else {
    hideMainUI();
    openAuthModal();
  }
}

async function fetchUserData() {
  if (isMining) return;
  
  try {
    const response = await fetch(`${API_URL}/user?userId=${currentUserId}`);
    if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
    const data = await response.json();
    if (data.success && data.user) {
      if (data.user.blocked === 1) {
        alert("–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
        logout();
        return;
      }
      const balance = parseFloat(data.user.balance || 0);
      localBalance = balance;
      updateBalanceUI();
      updateExchangeModalInfo(data.user);
    } else {
      console.error("[Fetch User Data] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
      localBalance = 0;
      updateBalanceUI();
    }
  } catch (error) {
    console.error("[Fetch User Data] –û—à–∏–±–∫–∞:", error.message);
    localBalance = 0;
    updateBalanceUI();
  }
}

// ==================== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ======================
function getDateLabel(dateObj) {
  const today = new Date();
  const yesterday = new Date();
  yesterday.setDate(today.getDate() - 1);
  if (dateObj.toDateString() === today.toDateString()) return "–°–µ–≥–æ–¥–Ω—è";
  if (dateObj.toDateString() === yesterday.toDateString()) return "–í—á–µ—Ä–∞";
  const day = ("0" + dateObj.getDate()).slice(-2);
  const month = ("0" + (dateObj.getMonth() + 1)).slice(-2);
  const year = dateObj.getFullYear();
  return `${day}.${month}.${year}`;
}

function displayTransactionHistory(transactions) {
  const transactionList = document.getElementById("transactionList");
  transactionList.innerHTML = "";
  if (transactions.length === 0) {
    transactionList.innerHTML = "<li>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</li>";
    return;
  }
  const groups = {};
  transactions.forEach(tx => {
    const dateObj = new Date(tx.created_at);
    const dateStr = getDateLabel(dateObj);
    if (!groups[dateStr]) groups[dateStr] = [];
    groups[dateStr].push(tx);
  });
  const sortedDates = Object.keys(groups).sort((a, b) => {
    const dateA = new Date(groups[a][0].created_at);
    const dateB = new Date(groups[b][0].created_at);
    return dateB - dateA;
  });
  sortedDates.forEach(dateStr => {
    const groupContainer = document.createElement("div");
    groupContainer.className = "history-group";
    const dateHeader = document.createElement("div");
    dateHeader.className = "history-date";
    dateHeader.textContent = dateStr;
    groupContainer.appendChild(dateHeader);
    groups[dateStr].forEach(tx => {
      const opContainer = document.createElement("div");
      opContainer.className = "history-item";
      let opTypeLabel = "";
      if (tx.type === "sent") {
        opTypeLabel = "–ò—Å—Ö–æ–¥—è—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚§¥";
      } else if (tx.type === "received") {
        opTypeLabel = "–í—Ö–æ–¥—è—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚§µ";
      } else if (tx.type === "merchant") {
        opTypeLabel = "–û–ø–ª–∞—Ç–∞ –º–µ—Ä—á–∞–Ω—Ç—É üí≥";
      }
      let counterpart = "";
      if (tx.type === "sent") {
        counterpart = `–ö–æ–º—É: ${tx.to_user_id}`;
      } else if (tx.type === "received") {
        counterpart = `–û—Ç –∫–æ–≥–æ: ${tx.from_user_id}`;
      } else if (tx.type === "merchant") {
        // –î–ª—è –º–µ—Ä—á–∞–Ω—Ç-–æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ë–î: user_id, merchant_id
        counterpart = `–ú–µ—Ä—á–∞–Ω—Ç: ${tx.merchant_id || "???"}`;
      }
      const amountStr = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ‚Ç≤ ${formatBalance(tx.amount)}`;
      const timeStr = `–í—Ä–µ–º—è: ${new Date(tx.created_at).toLocaleTimeString("ru-RU")}`;
      opContainer.innerHTML = `<div>${opTypeLabel}</div>
                               <div>${counterpart}</div>
                               <div>${amountStr}</div>
                               <div>${timeStr}</div>`;
      groupContainer.appendChild(opContainer);
    });
    groupContainer.style.width = "100%";
    groupContainer.style.marginLeft = "auto";
    groupContainer.style.marginRight = "auto";
    transactionList.appendChild(groupContainer);
  });
}

function openPaymentModal() {
  const modalContent = `
    <h3>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</h3>
    <div id="transferContent" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; max-width: 400px; margin: 0 auto;">
      <div style="width: 100%; text-align: center;">
        <label for="toUserIdInput">–ö–æ–º—É (ID):</label>
        <input type="text" id="toUserIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
      </div>
      <div style="width: 100%; text-align: center; margin: 15px 0;">
        <label for="transferAmountInput">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
        <input type="number" id="transferAmountInput" step="0.00001" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">
      </div>
      <button id="sendTransferBtn" style="max-width: 200px; margin: 15px auto;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  `;
  const modal = createModal("paymentModal", modalContent);
  const sendTransferBtn = modal.querySelector("#sendTransferBtn");
  if (sendTransferBtn) {
    sendTransferBtn.addEventListener("click", async () => {
      await sendTransfer();
    });
  }
  openModal("paymentModal");
}

function openHistoryModal() {
  const modal = createModal("historyModal", `
    <h3>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
    <div class="scrollable-content">
      <ul id="transactionList"></ul>
    </div>
  `);
  fetchTransactionHistory();
  openModal("historyModal");
}

async function fetchTransactionHistory() {
  try {
    const response = await fetch(`${API_URL}/transactions?userId=${currentUserId}`);
    if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
    const data = await response.json();
    if (data.success && data.transactions) {
      displayTransactionHistory(data.transactions);
    } else {
      console.error("[Fetch Transactions] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
    }
  } catch (error) {
    console.error("[Fetch Transactions] –û—à–∏–±–∫–∞:", error.message);
  }
}

function openExchangeModal() {
  const modalContent = `
    <h3>–û–±–º–µ–Ω—è—Ç—å</h3>
    <div id="exchangeContent" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
      <p id="exchangeRateInfo"></p>
      <p id="rubBalanceInfo"></p>
      <p id="halvingLevel"></p>
    </div>
  `;
  const modal = createModal("exchangeModal", modalContent);
  fetchUserData();
  openModal("exchangeModal");
}

function updateExchangeModalInfo(user) {
  const halvingStep = user.halvingStep || 0;
  const rubMultiplier = 1 + halvingStep * 0.02;
  const rubBalance = (localBalance * rubMultiplier).toFixed(2);
  const exchangeRateInfo = document.getElementById("exchangeRateInfo");
  const rubBalanceInfo = document.getElementById("rubBalanceInfo");
  const halvingLevel = document.getElementById("halvingLevel");
  if (exchangeRateInfo) {
    exchangeRateInfo.textContent = `–ö—É—Ä—Å: 1 ‚Ç≤ = ${rubMultiplier.toFixed(2)} ‚ÇΩ`;
  }
  if (rubBalanceInfo) {
    rubBalanceInfo.textContent = `–ë–∞–ª–∞–Ω—Å: ${rubBalance} ‚ÇΩ`;
  }
  if (halvingLevel) {
    halvingLevel.textContent = `–£—Ä–æ–≤–µ–Ω—å —Ö–∞–ª–≤–∏–Ω–≥–∞: ${halvingStep}`;
  }
}

async function sendTransfer() {
  const toUserId = document.getElementById("toUserIdInput")?.value;
  const amount = parseFloat(document.getElementById("transferAmountInput")?.value);
  if (!toUserId || !amount || amount <= 0) {
    alert("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
    return;
  }
  if (toUserId === currentUserId) {
    alert("‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–º—É —Å–µ–±–µ");
    return;
  }
  try {
    const response = await fetch(`${API_URL}/transfer`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fromUserId: currentUserId,
        toUserId: toUserId,
        amount: amount
      })
    });
    const data = await response.json();
    if (data.success) {
      alert("‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
      const modal = document.getElementById("paymentModal");
      if (modal) modal.remove();
      fetchUserData();
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: ${data.error}`);
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ:", error);
    alert("üö´ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
}

async function register() {
  const loginVal = document.getElementById("regLogin")?.value;
  const password = document.getElementById("regPassword")?.value;
  if (!loginVal || !password) {
    alert("‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å");
    return;
  }
  try {
    const response = await fetch(`${API_URL}/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: loginVal, password })
    });
    const data = await response.json();
    if (data.success) {
      alert(`‚úÖ –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–∞—à ID: ${data.userId}`);
      currentUserId = data.userId;
      localStorage.setItem("userId", currentUserId);
      createUI();
      updateUI();
      fetchUserData();
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${data.error}`);
    }
  } catch (error) {
    console.error(error);
    alert("üö´ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
}

async function login() {
  const loginVal = document.getElementById("loginInput")?.value;
  const password = document.getElementById("passwordInput")?.value;
  if (!loginVal || !password) {
    alert("‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å");
    return;
  }
  try {
    const response = await fetch(`${API_URL}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: loginVal, password })
    });
    const data = await response.json();
    if (data.success) {
      currentUserId = data.userId;
      localStorage.setItem("userId", currentUserId);
      createUI();
      updateUI();
      fetchUserData();
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${data.error}`);
    }
  } catch (error) {
    console.error(error);
    alert("üö´ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
}

// ==================== –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ: –û–ü–õ–ê–¢–ê –ú–ï–†–ß–ê–ù–¢–£ –ß–ï–†–ï–ó QR ======================

/**
 * –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å":
 *  1) –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
 *  2) –°–∫–∞–Ω–∏—Ä—É–µ–º QR, –≤ –∫–æ—Ç–æ—Ä–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞—à–∏—Ç merchantId
 *  3) –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–æ—Ä–º–æ–π (amount, purpose)
 *  4) –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å /payMerchant
 */

// –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR
function openMerchantPayModal() {
  // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª, –≤–Ω—É—Ç—Ä–∏ ‚Äî –±–ª–æ–∫ <video>, –≥–¥–µ –±—É–¥–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –∫–∞–º–µ—Ä–∞
  const modalContent = `
    <h3>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR</h3>
    <div style="text-align:center;">
      <video id="merchantPayVideo" style="width: 100%; max-width: 400px; border: 1px solid #000;" autoplay muted playsinline></video>
      <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –º–µ—Ä—á–∞–Ω—Ç–∞</p>
    </div>
  `;
  const modal = createModal("merchantPayModal", modalContent);
  openModal("merchantPayModal");

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  startQRScanner("merchantPayVideo");
}

// –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç BarcodeDetector, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
// –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä jsQR –∏–ª–∏ zxing.
async function startQRScanner(videoElementId) {
  const video = document.getElementById(videoElementId);
  if (!video) return;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    video.play();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É BarcodeDetector
    if (!('BarcodeDetector' in window)) {
      alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç BarcodeDetector. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π.");
      return;
    }
    const detector = new BarcodeDetector({ formats: ['qr_code'] });

    const scan = async () => {
      try {
        const barcodes = await detector.detect(video);
        if (barcodes.length > 0) {
          // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ QR —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ "merchantId=123456"
          const rawValue = barcodes[0].rawValue;
          console.log("QR detected:", rawValue);

          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
          stopVideoStream(video);

          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          document.getElementById("merchantPayModal")?.remove();

          // –ò–∑ QR –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å merchantId
          const merchantId = parseMerchantIdFromQR(rawValue);
          if (!merchantId) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å merchantId –∏–∑ QR");
            return;
          }

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
          openConfirmMerchantPaymentModal(merchantId);
        } else {
          requestAnimationFrame(scan);
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏:", err);
        requestAnimationFrame(scan);
      }
    };
    requestAnimationFrame(scan);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
    alert("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É");
  }
}

function stopVideoStream(video) {
  const stream = video.srcObject;
  if (stream) {
    const tracks = stream.getTracks();
    tracks.forEach(track => track.stop());
  }
  video.srcObject = null;
}

// –ü—Ä–æ—Å—Ç–µ–π—à–∏–π —Ä–∞–∑–±–æ—Ä. –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, QR-–∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–∏–π URL/—Å—Ç—Ä–æ–∫—É, –Ω–∞–ø—Ä–∏–º–µ—Ä: "guga://merchantId=123456"
function parseMerchantIdFromQR(rawValue) {
  // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç "merchantId=xxxxx"
  const match = rawValue.match(/merchantId=(\d+)/);
  return match ? match[1] : null;
}

// –ú–æ–¥–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã –º–µ—Ä—á–∞–Ω—Ç—É
function openConfirmMerchantPaymentModal(merchantId) {
  const modalContent = `
    <h3>–û–ø–ª–∞—Ç–∞ –º–µ—Ä—á–∞–Ω—Ç—É ${merchantId}</h3>
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; max-width: 400px; margin: 0 auto;">
      <label>–°—É–º–º–∞ (‚Ç≤):</label>
      <input type="number" id="merchantPayAmountInput" step="0.00001" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">

      <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:</label>
      <input type="text" id="merchantPayPurposeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–≤–∞—Ä #123">
      
      <button id="merchantPaySendBtn" style="margin-top:15px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  `;
  const modal = createModal("confirmMerchantPaymentModal", modalContent);
  openModal("confirmMerchantPaymentModal");

  const sendBtn = modal.querySelector("#merchantPaySendBtn");
  sendBtn.addEventListener("click", () => {
    const amountVal = parseFloat(document.getElementById("merchantPayAmountInput")?.value);
    const purposeVal = document.getElementById("merchantPayPurposeInput")?.value || "";
    if (!amountVal || amountVal <= 0) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
      return;
    }
    payMerchant(merchantId, amountVal, purposeVal);
  });
}

// –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä /payMerchant
async function payMerchant(merchantId, amount, purpose) {
  try {
    const response = await fetch(`${API_URL}/payMerchant`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUserId,
        merchantId: merchantId,
        amount: amount,
        purpose: purpose
      })
    });
    const data = await response.json();
    if (data.success) {
      alert("‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!");
      document.getElementById("confirmMerchantPaymentModal")?.remove();
      fetchUserData();
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ${data.error}`);
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –º–µ—Ä—á–∞–Ω—Ç—É:", error);
    alert("üö´ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
}

// ==================== –°–¢–ê–†–¢ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ======================
document.addEventListener("DOMContentLoaded", () => {
  if (pendingMinedCoins > 0) {
    flushMinedCoins();
  }
  const savedUserId = localStorage.getItem("userId");
  if (savedUserId) {
    currentUserId = savedUserId;
    createUI();
    fetchUserData();
    updateUI();
  } else {
    openAuthModal();
  }
});

window.addEventListener("beforeunload", () => {
  if (pendingMinedCoins > 0) {
    flushMinedCoinsSync();
  }
});

document.getElementById("mineBtn")?.addEventListener("click", mineCoins);
  </script>
</body>
</html>
